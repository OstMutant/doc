version: "3.9"

# =================================================================
# üöÄ –ü–û–í–ù–ò–ô –ê–õ–ì–û–†–ò–¢–ú –î–Ü–ô: –í–Ü–î –ó–ê–ü–£–°–ö–£ –î–û –ü–ï–†–®–û–á –í–Ü–î–ü–û–í–Ü–î–Ü
# =================================================================
# 
# üõ† –ö–†–û–ö 1: –ó–ê–ü–£–°–ö –£ –¢–ï–†–ú–Ü–ù–ê–õ–Ü
#    1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ PowerShell –∞–±–æ WSL —É –ø–∞–ø—Ü—ñ –∑ —Ü–∏–º —Ñ–∞–π–ª–æ–º.
#    2. –í–≤–µ–¥—ñ—Ç—å: docker compose up -d
#
# üì• –ö–†–û–ö 2: –ú–û–ù–Ü–¢–û–†–ò–ù–ì –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø (–í–∞–∂–ª–∏–≤–æ!)
#    1. –í–≤–µ–¥—ñ—Ç—å: docker logs -f ollama-init
#    2. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—è, –ø–æ–∫–∏ –≤—Å—ñ 3 –º–æ–¥–µ–ª—ñ (14b, 7b, nomic) –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è –Ω–∞ 100%.
#    3. –ö–æ–ª–∏ –ø–æ–±–∞—á–∏—Ç–µ, —â–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ollama-init –∑—É–ø–∏–Ω–∏–≤—Å—è ‚Äî –≤—Å–µ –≥–æ—Ç–æ–≤–æ.
#
# üåê –ö–†–û–ö 3: –ü–ï–†–®–ò–ô –í–•–Ü–î
#    1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ —É –±—Ä–∞—É–∑–µ—Ä—ñ: http://localhost:3000
#    2. –°—Ç–≤–æ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç. –ü–µ—Ä—à–∏–π —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∞–∫–∞—É–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞–Ω–µ –ê–î–ú–Ü–ù–û–ú.
#
# üß† –ö–†–û–ö 4: –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ü–ê–ú'–Ø–¢–Ü (–î–ª—è RTX 5060 Ti 16GB)
#    1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —ñ–∫–æ–Ω–∫—É –ø—Ä–æ—Ñ—ñ–ª—é (–∑–Ω–∏–∑—É –∑–ª—ñ–≤–∞) -> Settings.
#    2. –û–±–µ—Ä—ñ—Ç—å –≤–∫–ª–∞–¥–∫—É "Models" —É –ª—ñ–≤–æ–º—É –º–µ–Ω—é.
#    3. –ë—ñ–ª—è –º–æ–¥–µ–ª—ñ 'qwen2.5:14b' –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å —ñ–∫–æ–Ω–∫—É –æ–ª—ñ–≤—Ü—è (Edit).
#    4. –ü—Ä–æ–∫—Ä—É—Ç—ñ—Ç—å –≤–Ω–∏–∑ –¥–æ "Advanced Parameters".
#    5. –ó–Ω–∞–π–¥—ñ—Ç—å "Context Length" —ñ –∑–º—ñ–Ω—ñ—Ç—å 2048 –Ω–∞ 16384.
#    6. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Save" (–ó–±–µ—Ä–µ–≥—Ç–∏).
#
# üìÇ –ö–†–û–ö 5: –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–û–ö–£–ú–ï–ù–¢–Ü–í (RAG)
#    1. –£ –≥–æ–ª–æ–≤–Ω–æ–º—É –º–µ–Ω—é –∑–ª—ñ–≤–∞ –æ–±–µ—Ä—ñ—Ç—å "Workspace" -> "Documents".
#    2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "+" —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø–∞–ø–∫—É 'doc/' –∞–±–æ –æ–∫—Ä–µ–º—ñ .md —Ñ–∞–π–ª–∏.
#    3. –£ —á–∞—Ç—ñ –ø–∏—à—ñ—Ç—å —Å–∏–º–≤–æ–ª # —ñ –æ–±–∏—Ä–∞–π—Ç–µ –Ω–∞–∑–≤—É –¥–æ–∫—É–º–µ–Ω—Ç–∞, —â–æ–± –®–Ü –∞–Ω–∞–ª—ñ–∑—É–≤–∞–≤ –π–æ–≥–æ.
# =================================================================

services:
  # --- –î–≤–∏–≥—É–Ω –º–æ–¥–µ–ª–µ–π (GPU) ---
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    environment:
      - OLLAMA_NUM_PARALLEL=4      # –©–æ–± IDEA –º–æ–≥–ª–∞ –æ–¥–Ω–æ—á–∞—Å–Ω–æ —ñ —á–∞—Ç–∏—Ç–∏—Å—å, —ñ –∫–æ–¥ –ø—ñ–¥–∫–∞–∑—É–≤–∞—Ç–∏
      - OLLAMA_MAX_LOADED_MODELS=2 # –©–æ–± –æ–±–∏–¥–≤—ñ –º–æ–¥–µ–ª—ñ (14b —ñ 7b) –∂–∏–ª–∏ –≤ –ø–∞–º'—è—Ç—ñ –∫–∞—Ä—Ç–∏
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- –ê–≤—Ç–æ-—ñ–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä –º–æ–¥–µ–ª–µ–π ---
  ollama-init:
    image: ollama/ollama:latest
    container_name: ollama-init
    environment:
      - OLLAMA_HOST=ollama:11434
    volumes:
      - ollama_models:/root/.ollama
    depends_on:
      ollama:
        condition: service_healthy
    command: >
      sh -c "sleep 5 && 
             ollama pull qwen2.5:14b && 
             ollama pull qwen2.5-coder:7b && 
             ollama pull nomic-embed-text"
    restart: on-failure

  # --- –í–µ–∫—Ç–æ—Ä–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö ---
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    shm_size: "1gb"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ---
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    restart: always
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - VECTOR_DB_TYPE=qdrant
      - VECTOR_DB_URL=http://qdrant:6333
      - RAG_EMBEDDING_ENGINE=ollama
      - RAG_EMBEDDING_MODEL=nomic-embed-text
      - RAG_TOP_K=10
      - RAG_RELEVANCE_THRESHOLD=0.4
      - TEXT_SPLITTER_CHUNK_SIZE=800
      - TEXT_SPLITTER_CHUNK_OVERLAP=80
      - ENABLE_RAG_WEB_SEARCH=True
      - WEBUI_SECRET_KEY=ost_secret_key_2025_strong
      - WEBUI_AUTH=True
      - DEFAULT_MODEL=qwen2.5:14b
    volumes:
      - openwebui_data:/app/data
    depends_on:
      ollama:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    user: root
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  ollama_models:
    name: ollama_models
  openwebui_data:
    name: openwebui_data
  qdrant_data:
    name: qdrant_data